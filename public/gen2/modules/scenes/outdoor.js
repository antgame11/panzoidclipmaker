var DEBUG=!0;this.save=function(t){var e={skymode:this.skymode,landmode:this.landmode};if(PZ.archive.addFileString(t,JSON.stringify(e)),-1===this.skymode)for(var i=0;i<6;i++){var s=this.materials[i];null!==s.map&&null!==s.image&&(CM.templates.saveWaiting++,PZ.imageToArray(s.map.image,function(e,i){PZ.archive.addFile(t+"_img"+e,new Uint8Array(i)),CM.templates.saveWaiting--,CM.templates.saveComplete()}.bind(null,i)))}},this.load=function(t){if(CM.scene.fog=new THREE.FogExp2(16777215,.001),CM.updateMaterials(),this.skygeometry=new THREE.BoxGeometry(2500,2500,2500),this.land=null,this.landmaterial=null,this.landgeometry=null,this.materials=[],this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.materials.push(new THREE.MeshBasicMaterial({side:THREE.BackSide,fog:!1})),this.sunlight=new THREE.DirectionalLight(16777215,1),this.sunlight.castShadow=!0,this.sunlight.shadow.mapSize.width=2048,this.sunlight.shadow.mapSize.height=2048,this.sunlight.shadow.camera.near=100,this.sunlight.shadow.camera.far=2500,this.sunlight.shadow.camera.fov=50,this.sunlight.shadow.bias=1e-4,CM.scene.add(this.sunlight),CM.updateMaterials(),this.skymaterial=new THREE.MultiMaterial(this.materials),this.skybox=new THREE.Mesh(this.skygeometry,this.skymaterial),this.skybox.layers.enable(10),CM.scene.add(this.skybox),void 0!==t){var e=PZ.archive.getFileString(t);if(void 0!==e)var i=JSON.parse(e);for(var s=0;s<6;s++){var o=PZ.archive.getFileBlob(t+"_img"+s);if(void 0!==o){var a=this.materials[s],n=new Image;n.onload=function(t,e){t.map=new THREE.Texture(e.srcElement),t.map.needsUpdate=!0,t.needsUpdate=!0}.bind(null,a),a.objURL=URL.createObjectURL(o),n.src=a.objURL}}}this.skymode=i?i.skymode:PZ.random.number(1,12,!0),this.landmode=i?i.landmode:0,this.updateSky(),this.updateLand()},this.unload=function(){CM.scene.remove(this.sunlight),CM.updateMaterials(),CM.scene.remove(this.skybox),this.land&&CM.scene.remove(this.land),this.skymaterial=null,this.skygeometry=null,this.materials&&(this.materials=null),this.landmaterial=null,this.landgeometry=null,CM.hemiLight.intensity=1,CM.hemiLight.color.setHex(16777215),CM.hemiLight.groundColor.setHex(16777215),CM.scene.fog=null,CM.updateMaterials()},this.CUSTOMINDEX=13,this.props={sky:{title:"Sky",items:"off;cloudy light rays;dark stormy;full moon;sunset;thick clouds water;tropical sunny day;space;tron;mars;mercury;underworld;above the clouds;custom",get:function(){return-1===this.skymode?this.CUSTOMINDEX:this.skymode},set:function(t){t===this.CUSTOMINDEX?(this.$custom.show(),this.skymode=-1):(this.$custom.hide(),this.skymode=t),this.updateSky()}},custom_left:{title:"Left",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[0])}},custom_right:{title:"Right",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[1])}},custom_top:{title:"Top",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[2])}},custom_bottom:{title:"Bottom",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[3])}},custom_front:{title:"Front",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[4])}},custom_back:{title:"Back",accept:"image/*",set:function(t){this.fileUploadFn(t,this.materials[5])}},fogColor:void 0,hemiSkyColor:void 0,hemiGroundColor:void 0,hemiIntensity:void 0,directionalColor:void 0,directionalPosition:void 0,directionalIntensity:void 0,printData:void 0,land:{title:"Land",items:"off;flat;terrain",get:function(){return this.landmode},set:function(t){ctx.landmode=t,ctx.updateLand()}}},this.select=function(t){var e=this;PZ.editor.generateTitle({title:"Outdoor"}).appendTo(t),PZ.editor.generateDropdown(e.props.sky,e).appendTo(t),e.$custom=PZ.editor.generatePlaceholder().appendTo(t).hide(),PZ.editor.generateFileUpload(e.props.custom_left,e).appendTo(e.$custom),PZ.editor.generateFileUpload(e.props.custom_right,e).appendTo(e.$custom),PZ.editor.generateFileUpload(e.props.custom_top,e).appendTo(e.$custom),PZ.editor.generateFileUpload(e.props.custom_bottom,e).appendTo(e.$custom),PZ.editor.generateFileUpload(e.props.custom_front,e).appendTo(e.$custom),PZ.editor.generateFileUpload(e.props.custom_back,e).appendTo(e.$custom),PZ.editor.generateSpacer().appendTo(t),PZ.editor.generateDropdown(e.props.land,e).appendTo(t)},this.updateLand=function(){switch(this.landmode){case 0:this.land&&(CM.scene.remove(this.land),this.land=null);break;case 1:this.landgeometry=new THREE.PlaneGeometry(400,400),this.landmaterial=new THREE.MeshPhongMaterial({ambient:197379,specular:0,color:16777215,map:THREE.ImageUtils.loadTexture("/tools/im/scene/outdoor/herbe_3.jpg")}),this.landmaterial.map.wrapS=this.landmaterial.map.wrapT=THREE.RepeatWrapping,this.landmaterial.map.repeat.set(5,5),this.land=new THREE.Mesh(this.landgeometry,this.landmaterial),this.land.rotation.x=-Math.PI/2,CM.scene.add(this.land)}},this.updateSky=function(){for(var t=0;t<6;t++)this.materials[t].map&&(this.materials[t].map.dispose(),this.materials[t].map=null);var e="";switch(this.skymode){default:return this.sunlight.intensity=0,CM.hemiLight.color.setHex(16777215),CM.hemiLight.groundColor.setHex(16777215),void(CM.hemiLight.intensity=.2);case 1:e="CloudyLightRays",CM.scene.fog.color.setHex(4935506),this.sunlight.position.set(496.2,219.9,-348.5),this.sunlight.color.setHex(16377810),this.sunlight.intensity=1.2,CM.hemiLight.color.setHex(15263976),CM.hemiLight.groundColor.setHex(11326951),CM.hemiLight.intensity=.4;break;case 2:e="DarkStormy",CM.scene.fog.color.setHex(1974564),this.sunlight.position.set(-297.9,107.7,-10.8),this.sunlight.color.setHex(13946824),this.sunlight.intensity=.4,CM.hemiLight.color.setHex(15263976),CM.hemiLight.groundColor.setHex(5201266),CM.hemiLight.intensity=.4;break;case 3:e="FullMoon",CM.scene.fog.color.setHex(1975077),this.sunlight.position.set(453.5,156.8,-164.8),this.sunlight.color.setHex(16711422),this.sunlight.intensity=.4,CM.hemiLight.color.setHex(0),CM.hemiLight.groundColor.setHex(10396374),CM.hemiLight.intensity=.2;break;case 4:e="SunSet",CM.scene.fog.color.setHex(4145988),this.sunlight.position.set(472,33.6,-221.5),this.sunlight.color.setHex(15650387),this.sunlight.intensity=1.8,CM.hemiLight.color.setHex(9350350),CM.hemiLight.groundColor.setHex(9738401),CM.hemiLight.intensity=.2;break;case 5:e="ThickCloudsWater",CM.scene.fog.color.setHex(8610121),this.sunlight.position.set(458.8778481214596,251.87787218355768,-501.37746196377486),this.sunlight.color.setHex(15780483),this.sunlight.intensity=1.2,CM.hemiLight.color.setHex(15263976),CM.hemiLight.groundColor.setHex(6721505),CM.hemiLight.intensity=.4;break;case 6:e="TropicalSunnyDay",CM.scene.fog.color.setHex(16514297),this.sunlight.position.set(-231.1,236.3,-643.6205049825829),this.sunlight.color.setHex(16777215),this.sunlight.intensity=1.2,CM.hemiLight.color.setHex(15263976),CM.hemiLight.groundColor.setHex(6525861),CM.hemiLight.intensity=.9;break;case 7:e="stars",CM.scene.fog.color.setHex(0),this.sunlight.position.set(-.0002102294643322545,277.5,.0001848400020773877),this.sunlight.color.setHex(13421772),this.sunlight.intensity=0,CM.hemiLight.color.setHex(16777215),CM.hemiLight.groundColor.setHex(16777215),CM.hemiLight.intensity=.6;break;case 8:e="tron",CM.scene.fog.color.setHex(2431494),this.sunlight.position.set(40.492785285191374,-858.699027292143,-40.4),this.sunlight.color.setHex(16238388),this.sunlight.intensity=1.8,CM.hemiLight.color.setHex(15921752),CM.hemiLight.groundColor.setHex(0),CM.hemiLight.intensity=.7;break;case 9:e="mars",CM.scene.fog.color.setHex(10770472),this.sunlight.position.set(-609.1061678483015,279.61876296644726,641.2560101232201),this.sunlight.color.setHex(16041888),this.sunlight.intensity=1,CM.hemiLight.color.setHex(15187321),CM.hemiLight.groundColor.setHex(12096575),CM.hemiLight.intensity=.7;break;case 10:e="mercury",CM.scene.fog.color.setHex(4133942),this.sunlight.position.set(-.0008729216198492796,883.4919228703098,.00013625646178184976),this.sunlight.color.setHex(14206126),this.sunlight.intensity=1,CM.hemiLight.color.setHex(15899976),CM.hemiLight.groundColor.setHex(9242889),CM.hemiLight.intensity=.8;break;case 11:e="hell",CM.scene.fog.color.setHex(1835266),this.sunlight.position.set(.0007196086560147312,-696.5,12591127644092392e-22),this.sunlight.color.setHex(13765644),this.sunlight.intensity=1,CM.hemiLight.color.setHex(15526360),CM.hemiLight.groundColor.setHex(8259078),CM.hemiLight.intensity=.9;break;case 12:e="clouds",CM.scene.fog.color.setHex(16098816),this.sunlight.position.set(-431.3,276.4,443.2),this.sunlight.color.setHex(16777215),this.sunlight.intensity=1,CM.hemiLight.color.setHex(15612680),CM.hemiLight.groundColor.setHex(15618866),CM.hemiLight.intensity=.7}if(""!==e){var i="assets/textures/sky/",s=new THREE.TextureLoader;this.materials[0].map=s.load(i+e+"/left.png"),this.materials[1].map=s.load(i+e+"/right.png"),this.materials[2].map=s.load(i+e+"/up.png"),this.materials[3].map=s.load(i+e+"/down.png"),this.materials[4].map=s.load(i+e+"/front.png"),this.materials[5].map=s.load(i+e+"/back.png")}},this.fileUploadFn=function(t,e){if(t.files&&t.files[0]){var i=new FileReader;i.onload=function(t){var i=new Image;i.onload=function(t){e.map&&(e.map.dispose(),e.map=null),e.objURL&&(URL.revokeObjectURL(e.objURL),delete e.objURL),e.map=new THREE.Texture(this),e.map.needsUpdate=!0},i.src=t.target.result},i.readAsDataURL(t.files[0])}},this.update=function(){!0===CM.renderMode?this.skybox.position.copy(CM.renderCamera.position):this.skybox.position.copy(CM.camera.position)},this.resize=function(){};